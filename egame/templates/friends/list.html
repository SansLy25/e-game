{% extends 'base-bs.html' %}
{% load static %}

{% block content %}
  <link rel="stylesheet" href="{% static 'css/bootstrap/bootstrap.min.css' %}" />
  <link rel="stylesheet" href="{% static 'css/base.css' %}" />
  <link rel="stylesheet" href="{% static 'css/form.css' %}" />
  <link rel="stylesheet" href="{% static 'css/friends.css' %}" />
  <link rel="stylesheet" href="{% static 'css/profile.css' %}" />

  <div class="container-lg">
    <div class="friends-container container-main container-rounded-x2">
      <section>
        <form method="get" class="search-form" id="search-form">
          <div class="flex-grow-1">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-search"></i></span>
              {{ search_form.username }}
            </div>
          </div>
        </form>
      </section>

      <section id="search-results-section"></section>

      <section>
        <h2 class="section-title">Заявки в друзья</h2>
        <div class="friends-list">
          {% for friend_request in pending_requests %}
            <div class="friend-card container-secondary container-rounded-x1_5">
              <div class="friend-info">
                <div class="profile-avatar">
                  <span>{{ friend_request.from_user.username|make_list|first|upper }}</span>
                </div>
                <div class="friend-details">
                  <h3 class="friend-username" title="{{ friend_request.from_user.username }}">{{ friend_request.from_user.username }}</h3>
                  <p class="friend-exams">
                    Экзамены:{% for exam in friend_request.from_user.exams.all %}
                      <span title="{{ exam.name }}">{{ exam.name }}</span>
                    {% endfor %}
                  </p>
                </div>
              </div>
              <div class="d-flex gap-2">
                <form method="post" action="{% url 'users:friends:accept' friend_request.pk %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-bg-subtle btn-success">
                    <i class="bi bi-person-check me-1"></i>
                    Принять
                  </button>
                </form>
                <form method="post" action="{% url 'users:friends:reject' friend_request.pk %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-bg-subtle btn-danger">
                    <i class="bi bi-person-x me-1"></i>
                    Отклонить
                  </button>
                </form>
              </div>
            </div>
          {% empty %}
            <div class="no-friends-message container-secondary container-rounded-x1_5">У вас пока нет заявок в друзья</div>
          {% endfor %}
        </div>
      </section>

      <section>
        <h2 class="section-title">Мои друзья</h2>
        <div class="friends-list">
          {% for friend in friends %}
            <div class="friend-card container-secondary container-rounded-x1_5">
              <div class="friend-info">
                <div class="profile-avatar">
                  <span>{{ friend.username|make_list|first|upper }}</span>
                </div>
                <div class="friend-details">
                  <h3 class="friend-username" title="{{ friend.username }}">{{ friend.username }}</h3>
                  <p class="friend-exams">
                    Экзамены:{% for exam in friend.exams.all %}
                      <span title="{{ exam.name }}">{{ exam.name }}</span>
                    {% endfor %}
                  </p>
                </div>
              </div>
              <form method="post" action="{% url 'users:friends:remove' friend.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-bg-subtle btn-danger">
                  <i class="bi bi-person-dash me-1"></i>
                  Удалить
                </button>
              </form>
            </div>
          {% empty %}
            <div class="no-friends-message container-secondary container-rounded-x1_5">У вас пока нет друзей</div>
          {% endfor %}
        </div>
      </section>

      <section class="invite-section container-secondary container-rounded-x1_5">
        <h3 class="invite-title">Пригласить друга</h3>
        <div class="invite-content">
          <p class="invite-text">Поделитесь этой ссылкой с друзьями:</p>
          <div class="invite-link">
            <div class="input-group">
              <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
              <input type="text" value="{{ request.scheme }}://{{ request.get_host }}{% url 'users:friends:add_by_username' request.user.username %}" class="form-control invite-link-input" readonly />
            </div>
            <button onclick="navigator.clipboard.writeText('{{ request.scheme }}://{{ request.get_host }}{% url 'users:friends:add_by_username' request.user.username %}')" class="btn btn-bg-subtle-outline copy-button">
              <i class="bi bi-clipboard-fill me-1"></i>
              Копировать
            </button>
          </div>
          {% comment %} # TODO: make share button {% endcomment %}
        </div>
      </section>
    </div>

    {% if messages %}
      <div class="messages">
        {% for message in messages %}
          <div class="message {% if message.tags == 'success' %}
              message-success
            {% else %}
              message-error
            {% endif %}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  <script>
    const searchForm = document.getElementById('search-form')
    const searchResultsSection = document.getElementById('search-results-section')
    const usernameInput = searchForm.querySelector('input[name="username"]')
    
    function searchUsers() {
      const formData = new FormData(searchForm)
      const username = formData.get('username').trim()

      if (username) {
        fetch('{% url 'users:friends:search' %}?' + new URLSearchParams(formData).toString(), {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
          .then((response) => response.json())
          .then((data) => {
            console.log('Search results:', data)
            searchResultsSection.innerHTML = ''
    
            if (data.users && data.users.length > 0) {
              data.users.forEach((selected_user) => {
                console.log('Fetching user card for:', selected_user)
                searchResultsSection.innerHTML += `
                  {% include 'friends/user_card.html' with selected_user=selected_user %}
                `
              })
            } else {
              searchResultsSection.innerHTML = '<div class="no-results-message container-secondary container-rounded-x1_5">Пользователи не найдены</div>'
            }
          })
      } else {
        searchResultsSection.innerHTML = ''
      }
    }
    
    usernameInput.addEventListener('input', searchUsers)

    searchForm.addEventListener('keydown', function (event) {
      if (event.key === 'Enter') {
        event.preventDefault()
      }
    })
  </script>
{% endblock %}
